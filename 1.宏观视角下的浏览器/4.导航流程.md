## 从输入 URL 到页面展示，这中间发生了什么

大致描述

1. 首先，浏览器进程接收到用户输入的 URL 请求，浏览器进程便将该 URL 转发给网络进程。
2. 然后，在网络进程中发起真正的 URL 请求。
3. 接着网络进程接收到了响应头数据，便解析响应头数据，并将数据转发给浏览器进程。
4. 浏览器进程接收到网络进程的响应头数据之后，发送“提交导航 (CommitNavigation)”消息到渲染进程；
5. 渲染进程接收到“提交导航”的消息之后，便开始准备接收 HTML 数据，接收数据的方式是直接和网络进程建立数据管道；
6. 最后渲染进程会向浏览器进程“确认提交”，这是告诉浏览器进程：“已经准备好接受和解析页面数据了”。
7. 浏览器进程接收到渲染进程“提交文档”的消息之后，便开始移除之前旧的文档，然后更新浏览器进程中的页面状态。

### 从输入 URL 到页面展示

#### 1.用户输入

地址栏会判断用户输入的是搜索内容还是 URL

- 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL。
- 如果是 URL，地址栏会根据规则加上协议，生成完整的 URL

用户输入完毕键入回车后，当前页面会执行 beforeunload 事件，在此事件中可以取消后续过程

进入到下一阶段后，页面的 tab 栏开始进入 loadng 状态，但是页面还是之前的页面

#### 2. URL 请求过程

1. 浏览器进程通过进程间通信（IPC）将 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会发起真正的 URL 请求流程
2. 网络进程会查找本地缓存是否缓存了该资源，如果有缓存资源，那么直接返回资源给浏览器进程，如果没有缓存，则进入网络请求流程
3. 进行 dns 解析，获取 ip 地址，如果请求协议是 https，那么还要建立 TLS 连接
4. 利用 IP 地址和服务器建立 TCP 连接，建立之后，浏览器端会构建请求行、请求头等信息，并把和该域名相关的 Cookie 等数据附加到请求头中，然后向服务器发送构建的请求信息。
5. 服务器接收到请求信息后，会根据请求信息生成响应数据，并发给网络进程，网络进程开始解析响应头内容
6. 网络进程开始解析响应头，如果发现返回的状态码是 301 或者 302，那么说明服务器需要浏览器重定向到其他 URL。这时网络进程会从响应头的 Location 字段里面读取重定向的地址，然后再发起新的 HTTP 或者 HTTPS 请求
7. 如果 Content-Type 字段的值被浏览器判断为下载类型，那么该请求会被提交给浏览器的下载管理器，同时该 URL 请求的导航流程就此结束。但如果是 HTML，那么浏览器则会继续进行导航流程。

#### 3.准备渲染进程

默认情况下，Chrome 会为每个页面分配一个渲染进程，但是，也有一些例外，在某些情况下，浏览器会让多个页面直接运行在同一个渲染进程中。

我们将“同一站点”定义为根域名加上协议

如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程。

#### 4.提交文档

1. 浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息；
2. 渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”；
3. 等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程；
4. 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。

#### 5.渲染阶段

一旦文档被提交，渲染进程便开始页面解析和子资源加载了
